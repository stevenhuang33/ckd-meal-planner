<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CKD Stage 3 Meal Planner</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600&family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0d9488;
            --primary-light: #14b8a6;
            --primary-dark: #0f766e;
            --secondary: #f5e6d3;
            --accent: #f97316;
            --bg: #fafaf9;
            --surface: #ffffff;
            --surface-elevated: #ffffff;
            --text: #1c1917;
            --text-secondary: #78716c;
            --text-muted: #a8a29e;
            --border: #e7e5e4;
            --green: #22c55e;
            --yellow: #eab308;
            --red: #ef4444;
            --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 4px 12px rgba(0,0,0,0.05);
            --shadow-lg: 0 4px 6px rgba(0,0,0,0.07), 0 10px 20px rgba(0,0,0,0.05);
            --radius: 12px;
            --radius-sm: 8px;
        }

        [data-theme="dark"] {
            --bg: #1c1917;
            --surface: #292524;
            --surface-elevated: #44403c;
            --text: #fafaf9;
            --text-secondary: #a8a29e;
            --text-muted: #78716c;
            --border: #44403c;
            --shadow: 0 1px 3px rgba(0,0,0,0.3), 0 4px 12px rgba(0,0,0,0.2);
            --shadow-lg: 0 4px 6px rgba(0,0,0,0.3), 0 10px 20px rgba(0,0,0,0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            transition: background 0.3s, color 0.3s;
        }

        h1, h2, h3, h4 {
            font-family: 'Outfit', sans-serif;
        }

        .header {
            background: linear-gradient(135deg, #0d9488 0%, #0f766e 50%, #115e59 100%);
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 44px;
            height: 44px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .header h1 {
            color: white;
            font-size: 24px;
            font-weight: 700;
        }

        .header-subtitle {
            color: rgba(255,255,255,0.8);
            font-size: 13px;
            margin-top: 2px;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .btn {
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            font-weight: 500;
            padding: 10px 16px;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .btn-icon {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 10px;
        }

        .btn-icon:hover {
            background: rgba(255,255,255,0.3);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--surface);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--surface-elevated);
        }

        .btn-danger {
            background: var(--red);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-export {
            background: #7c3aed;
            color: white;
        }

        .btn-export:hover {
            background: #6d28d9;
        }

        .btn-import {
            background: #0369a1;
            color: white;
        }

        .btn-import:hover {
            background: #0284c7;
        }

        .patient-bar {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .patient-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .weight-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .weight-input-group label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .weight-input {
            width: 80px;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 15px;
            background: var(--bg);
            color: var(--text);
            font-family: 'DM Sans', sans-serif;
        }

        .weight-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .protein-target {
            font-size: 14px;
            color: var(--text-secondary);
            background: var(--bg);
            padding: 8px 14px;
            border-radius: var(--radius-sm);
        }

        .protein-target strong {
            color: var(--primary);
        }

        .main-container {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 0;
            min-height: calc(100vh - 180px);
        }

        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr;
            }
        }

        .food-panel {
            background: var(--surface);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 180px);
        }

        @media (max-width: 1024px) {
            .food-panel {
                max-height: 50vh;
                border-right: none;
                border-bottom: 1px solid var(--border);
            }
        }

        .panel-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .panel-header h2 {
            font-size: 18px;
            margin-bottom: 16px;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 12px 16px 12px 44px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 15px;
            background: var(--bg);
            color: var(--text);
            font-family: 'DM Sans', sans-serif;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }

        .category-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 16px;
        }

        .category-btn {
            padding: 8px 14px;
            border: 1px solid var(--border);
            border-radius: 20px;
            background: var(--bg);
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .category-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .food-grid {
            padding: 16px;
            overflow-y: auto;
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 12px;
            align-content: start;
        }

        .food-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .food-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
            border-color: var(--primary-light);
        }

        .food-card-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
            color: var(--text);
        }

        .food-card-portion {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .nutrient-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .nutrient-badge {
            font-size: 10px;
            padding: 3px 6px;
            border-radius: 4px;
            font-weight: 500;
            white-space: nowrap;
        }

        .badge-na { background: #fef3c7; color: #92400e; }
        .badge-k { background: #fce7f3; color: #9d174d; }
        .badge-p { background: #dbeafe; color: #1e40af; }
        .badge-protein { background: #dcfce7; color: #166534; }
        .badge-cal { background: #f3f4f6; color: #374151; }

        [data-theme="dark"] .badge-na { background: #78350f; color: #fef3c7; }
        [data-theme="dark"] .badge-k { background: #831843; color: #fce7f3; }
        [data-theme="dark"] .badge-p { background: #1e3a8a; color: #dbeafe; }
        [data-theme="dark"] .badge-protein { background: #14532d; color: #dcfce7; }
        [data-theme="dark"] .badge-cal { background: #374151; color: #f3f4f6; }

        .meal-panel {
            padding: 24px;
            overflow-y: auto;
            background: var(--bg);
        }

        .meal-sections {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 24px;
        }

        .meal-section {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .meal-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 14px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .meal-header h3 {
            font-size: 16px;
            font-weight: 600;
        }

        .meal-calories {
            font-size: 13px;
            background: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 12px;
        }

        .meal-content {
            padding: 16px;
            min-height: 80px;
        }

        .meal-content.empty {
            border: 2px dashed var(--border);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 14px;
        }

        .meal-food-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .meal-food-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            background: var(--bg);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
        }

        .meal-food-info {
            flex: 1;
        }

        .meal-food-name {
            font-weight: 500;
            font-size: 14px;
        }

        .meal-food-nutrients {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .remove-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
            font-size: 18px;
            line-height: 1;
        }

        .remove-btn:hover {
            color: var(--red);
            background: rgba(239, 68, 68, 0.1);
        }

        .totals-section {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px;
        }

        .totals-section h3 {
            font-size: 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .totals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
        }

        .total-item {
            background: var(--bg);
            padding: 14px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
        }

        .total-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .total-value {
            font-size: 22px;
            font-weight: 700;
            font-family: 'Outfit', sans-serif;
        }

        .total-target {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .progress-bar {
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s, background 0.3s;
        }

        .progress-green { background: var(--green); }
        .progress-yellow { background: var(--yellow); }
        .progress-red { background: var(--red); }

        .status-green { color: var(--green); }
        .status-yellow { color: var(--yellow); }
        .status-red { color: var(--red); }

        .saved-plans-bar {
            background: var(--surface);
            border-top: 1px solid var(--border);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .saved-plans-bar h4 {
            font-size: 14px;
            color: var(--text-secondary);
            margin-right: 8px;
        }

        .plan-input {
            flex: 1;
            min-width: 150px;
            max-width: 250px;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 14px;
            background: var(--bg);
            color: var(--text);
            font-family: 'DM Sans', sans-serif;
        }

        .plan-select {
            flex: 1;
            min-width: 150px;
            max-width: 250px;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 14px;
            background: var(--bg);
            color: var(--text);
            font-family: 'DM Sans', sans-serif;
            cursor: pointer;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 24px;
            max-width: 400px;
            width: 90%;
            box-shadow: var(--shadow-lg);
            transform: scale(0.9);
            transition: transform 0.2s;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal h3 {
            font-size: 18px;
            margin-bottom: 8px;
        }

        .modal-food-name {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .meal-selector {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .meal-option {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: inherit;
            font-size: 1rem;
            text-align: left;
        }

        .meal-option:hover {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(13, 148, 136, 0.3);
        }

        .meal-option:hover .meal-nutrients {
            color: rgba(255, 255, 255, 0.9);
        }

        .meal-option span:first-child {
            font-weight: 500;
        }

        .meal-option .meal-nutrients {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .modal-close {
            margin-top: 16px;
            width: 100%;
        }

        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 14px 20px;
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-lg);
            z-index: 1001;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            border-left: 4px solid var(--green);
        }

        .toast.error {
            border-left: 4px solid var(--red);
        }

        @media print {
            .header-actions, .patient-bar, .food-panel, .saved-plans-bar, .remove-btn {
                display: none !important;
            }

            .main-container {
                display: block;
            }

            .meal-panel {
                padding: 0;
            }

            body {
                background: white;
                color: black;
            }

            .meal-section, .totals-section {
                box-shadow: none;
                border: 1px solid #ddd;
                break-inside: avoid;
            }

            .meal-header {
                background: #f5f5f5 !important;
                color: black !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .print-header {
                display: block !important;
                text-align: center;
                margin-bottom: 24px;
                padding-bottom: 16px;
                border-bottom: 2px solid var(--primary);
            }

            .print-header h1 {
                color: var(--primary);
                font-size: 24px;
            }

            .print-date {
                color: #666;
                font-size: 14px;
            }
        }

        .print-header {
            display: none;
        }

        .print-meal-name {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--primary);
        }

        @media (max-width: 768px) {
            .header {
                padding: 16px;
            }

            .header h1 {
                font-size: 20px;
            }

            .patient-bar {
                padding: 12px 16px;
            }

            .meal-panel {
                padding: 16px;
            }

            .totals-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .no-results {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <div class="logo-icon">ü´ò</div>
            <div>
                <h1>CKD Stage 3 Meal Planner</h1>
                <div class="header-subtitle">Track your daily nutrition</div>
            </div>
        </div>
        <div class="header-actions">
            <button class="btn btn-icon" id="themeToggle" title="Toggle theme">
                <span id="themeIcon">üåô</span>
            </button>
            <button class="btn btn-icon" id="printBtn" title="Print meal plan">
                üñ®Ô∏è
            </button>
        </div>
    </header>

    <div class="print-header">
        <h1>CKD Stage 3 Meal Plan</h1>
        <div class="print-date" id="printDate"></div>
    </div>

    <div class="patient-bar">
        <div class="patient-info">
            <div class="weight-input-group">
                <label>Weight:</label>
                <input type="number" class="weight-input" id="weightInput" value="70" min="30" max="200">
                <span>kg</span>
            </div>
            <div class="protein-target">
                Daily protein target: <strong id="proteinTarget">56-70g</strong>
            </div>
        </div>
        <div style="font-size: 13px; color: var(--text-secondary);">
            <strong>Daily Limits:</strong> Sodium &lt;2000mg ‚Ä¢ Potassium 2000-3000mg ‚Ä¢ Phosphorus 800-1000mg
        </div>
    </div>

    <div class="main-container">
        <aside class="food-panel">
            <div class="panel-header">
                <h2>ü•ó Food Database</h2>
                <div class="search-box">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="searchInput" placeholder="Search foods...">
                </div>
                <div class="category-filters">
                    <button class="category-btn active" data-category="all">All</button>
                    <button class="category-btn" data-category="proteins">Proteins</button>
                    <button class="category-btn" data-category="vegetables">Vegetables</button>
                    <button class="category-btn" data-category="fruits">Fruits</button>
                    <button class="category-btn" data-category="grains">Grains</button>
                    <button class="category-btn" data-category="fats">Fats</button>
                </div>
            </div>
            <div class="food-grid" id="foodGrid"></div>
        </aside>

        <main class="meal-panel">
            <div class="meal-sections">
                <div class="meal-section" data-meal="breakfast">
                    <div class="meal-header">
                        <h3>üåÖ Breakfast</h3>
                        <span class="meal-calories" data-meal-cal="breakfast">0 cal</span>
                    </div>
                    <div class="meal-content" data-meal-content="breakfast">
                        <div class="meal-food-list"></div>
                        <div class="empty">Click foods to add to breakfast</div>
                    </div>
                </div>

                <div class="meal-section" data-meal="lunch">
                    <div class="meal-header">
                        <h3>‚òÄÔ∏è Lunch</h3>
                        <span class="meal-calories" data-meal-cal="lunch">0 cal</span>
                    </div>
                    <div class="meal-content" data-meal-content="lunch">
                        <div class="meal-food-list"></div>
                        <div class="empty">Click foods to add to lunch</div>
                    </div>
                </div>

                <div class="meal-section" data-meal="dinner">
                    <div class="meal-header">
                        <h3>üåô Dinner</h3>
                        <span class="meal-calories" data-meal-cal="dinner">0 cal</span>
                    </div>
                    <div class="meal-content" data-meal-content="dinner">
                        <div class="meal-food-list"></div>
                        <div class="empty">Click foods to add to dinner</div>
                    </div>
                </div>

                <div class="meal-section" data-meal="snacks">
                    <div class="meal-header">
                        <h3>üçé Snacks</h3>
                        <span class="meal-calories" data-meal-cal="snacks">0 cal</span>
                    </div>
                    <div class="meal-content" data-meal-content="snacks">
                        <div class="meal-food-list"></div>
                        <div class="empty">Click foods to add to snacks</div>
                    </div>
                </div>
            </div>

            <div class="totals-section">
                <h3>üìä Daily Totals</h3>
                <div class="totals-grid">
                    <div class="total-item">
                        <div class="total-label">Sodium</div>
                        <div class="total-value status-green" id="totalNa">0<small>mg</small></div>
                        <div class="total-target">&lt; 2000mg</div>
                        <div class="progress-bar">
                            <div class="progress-fill progress-green" id="progressNa" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="total-item">
                        <div class="total-label">Potassium</div>
                        <div class="total-value status-green" id="totalK">0<small>mg</small></div>
                        <div class="total-target">2000-3000mg</div>
                        <div class="progress-bar">
                            <div class="progress-fill progress-green" id="progressK" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="total-item">
                        <div class="total-label">Phosphorus</div>
                        <div class="total-value status-green" id="totalP">0<small>mg</small></div>
                        <div class="total-target">800-1000mg</div>
                        <div class="progress-bar">
                            <div class="progress-fill progress-green" id="progressP" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="total-item">
                        <div class="total-label">Protein</div>
                        <div class="total-value status-green" id="totalProtein">0<small>g</small></div>
                        <div class="total-target" id="targetProteinRange">56-70g</div>
                        <div class="progress-bar">
                            <div class="progress-fill progress-green" id="progressProtein" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="total-item">
                        <div class="total-label">Calories</div>
                        <div class="total-value" id="totalCal">0</div>
                        <div class="total-target">calories</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressCal" style="width: 0%; background: var(--primary)"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="saved-plans-bar">
        <h4>üíæ Saved Plans:</h4>
        <input type="text" class="plan-input" id="planNameInput" placeholder="Plan name...">
        <button class="btn btn-primary" id="savePlanBtn">Save</button>
        <select class="plan-select" id="planSelect">
            <option value="">Select a plan...</option>
        </select>
        <button class="btn btn-secondary" id="loadPlanBtn">Load</button>
        <button class="btn btn-danger" id="deletePlanBtn">Delete</button>
        <button class="btn btn-export" id="exportJsonBtn">Export JSON</button>
        <label class="btn btn-import" id="importJsonLabel" style="cursor:pointer; display:inline-flex; align-items:center;">
            Import JSON
            <input type="file" id="importJsonInput" accept=".json" style="display:none;">
        </label>
    </div>

    <div class="modal-overlay" id="mealModal">
        <div class="modal">
            <h3>Add to Meal</h3>
            <div class="modal-food-name" id="modalFoodName"></div>
            <p style="font-size: 14px; color: var(--text-secondary); margin: 12px 0; text-align: center;">Click a meal below to add this food:</p>
            <div class="meal-selector">
                <button class="meal-option" data-meal="breakfast">
                    <span>üåÖ Breakfast</span>
                    <span class="meal-nutrients" id="breakfastTotal">0 cal</span>
                </button>
                <button class="meal-option" data-meal="lunch">
                    <span>‚òÄÔ∏è Lunch</span>
                    <span class="meal-nutrients" id="lunchTotal">0 cal</span>
                </button>
                <button class="meal-option" data-meal="dinner">
                    <span>üåô Dinner</span>
                    <span class="meal-nutrients" id="dinnerTotal">0 cal</span>
                </button>
                <button class="meal-option" data-meal="snacks">
                    <span>üçé Snacks</span>
                    <span class="meal-nutrients" id="snacksTotal">0 cal</span>
                </button>
            </div>
            <button class="btn btn-secondary modal-close" id="closeModal">Cancel</button>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const foodDatabase = [
            { id: 1, name: "Chicken Breast", portion: "3oz (85g)", category: "proteins", na: 70, k: 280, p: 200, protein: 26, cal: 140 },
            { id: 2, name: "Egg Whites", portion: "2 large", category: "proteins", na: 110, k: 110, p: 110, protein: 14, cal: 60 },
            { id: 3, name: "Salmon", portion: "3oz (85g)", category: "proteins", na: 50, k: 300, p: 250, protein: 22, cal: 175 },
            { id: 4, name: "Tofu (firm)", portion: "¬Ω cup", category: "proteins", na: 8, k: 120, p: 120, protein: 10, cal: 76 },
            { id: 5, name: "Turkey Breast", portion: "3oz (85g)", category: "proteins", na: 45, k: 220, p: 180, protein: 25, cal: 125 },
            { id: 6, name: "Cod", portion: "3oz (85g)", category: "proteins", na: 60, k: 200, p: 180, protein: 19, cal: 70 },
            { id: 7, name: "Shrimp", portion: "3oz (85g)", category: "proteins", na: 190, k: 180, p: 175, protein: 18, cal: 85 },
            { id: 8, name: "Beef Sirloin", portion: "3oz (85g)", category: "proteins", na: 55, k: 280, p: 190, protein: 23, cal: 170 },
            { id: 9, name: "Pork Tenderloin", portion: "3oz (85g)", category: "proteins", na: 45, k: 320, p: 200, protein: 22, cal: 140 },
            { id: 10, name: "Lamb", portion: "3oz (85g)", category: "proteins", na: 60, k: 270, p: 185, protein: 22, cal: 175 },
            { id: 11, name: "Duck (no skin)", portion: "3oz (85g)", category: "proteins", na: 65, k: 240, p: 190, protein: 21, cal: 180 },
            { id: 12, name: "Cottage Cheese", portion: "¬Ω cup", category: "proteins", na: 350, k: 90, p: 110, protein: 12, cal: 90 },
            { id: 13, name: "Greek Yogurt", portion: "¬Ω cup", category: "proteins", na: 55, k: 150, p: 100, protein: 10, cal: 65 },
            { id: 14, name: "Tempeh", portion: "¬Ω cup", category: "proteins", na: 14, k: 150, p: 140, protein: 15, cal: 90 },
            { id: 15, name: "White Fish", portion: "3oz (85g)", category: "proteins", na: 55, k: 190, p: 170, protein: 18, cal: 75 },
            { id: 16, name: "Cabbage", portion: "1 cup", category: "vegetables", na: 20, k: 180, p: 25, protein: 1, cal: 25 },
            { id: 17, name: "Cauliflower", portion: "1 cup", category: "vegetables", na: 30, k: 320, p: 40, protein: 2, cal: 25 },
            { id: 18, name: "Bell Peppers", portion: "1 cup", category: "vegetables", na: 5, k: 250, p: 30, protein: 1, cal: 30 },
            { id: 19, name: "Cucumber", portion: "1 cup", category: "vegetables", na: 3, k: 175, p: 25, protein: 1, cal: 16 },
            { id: 20, name: "Green Beans", portion: "1 cup", category: "vegetables", na: 6, k: 190, p: 35, protein: 2, cal: 30 },
            { id: 21, name: "Lettuce", portion: "1 cup", category: "vegetables", na: 20, k: 140, p: 15, protein: 1, cal: 10 },
            { id: 22, name: "Onion", portion: "¬Ω cup", category: "vegetables", na: 4, k: 115, p: 20, protein: 1, cal: 30 },
            { id: 23, name: "Zucchini", portion: "1 cup", category: "vegetables", na: 12, k: 325, p: 45, protein: 2, cal: 20 },
            { id: 24, name: "Asparagus", portion: "6 spears", category: "vegetables", na: 3, k: 200, p: 50, protein: 2, cal: 20 },
            { id: 25, name: "Broccoli", portion: "1 cup", category: "vegetables", na: 30, k: 290, p: 55, protein: 3, cal: 30 },
            { id: 26, name: "Carrots", portion: "1 cup", category: "vegetables", na: 85, k: 390, p: 45, protein: 1, cal: 50 },
            { id: 27, name: "Celery", portion: "1 cup", category: "vegetables", na: 100, k: 260, p: 25, protein: 1, cal: 15 },
            { id: 28, name: "Kale", portion: "1 cup", category: "vegetables", na: 25, k: 180, p: 25, protein: 2, cal: 15 },
            { id: 29, name: "Spinach (raw)", portion: "1 cup", category: "vegetables", na: 25, k: 55, p: 15, protein: 1, cal: 7 },
            { id: 30, name: "Snow Peas", portion: "1 cup", category: "vegetables", na: 4, k: 190, p: 35, protein: 2, cal: 25 },
            { id: 31, name: "Apple", portion: "1 medium", category: "fruits", na: 2, k: 195, p: 15, protein: 0, cal: 95 },
            { id: 32, name: "Blueberries", portion: "¬Ω cup", category: "fruits", na: 1, k: 60, p: 10, protein: 0, cal: 40 },
            { id: 33, name: "Grapes", portion: "¬Ω cup", category: "fruits", na: 3, k: 90, p: 15, protein: 0, cal: 55 },
            { id: 34, name: "Pineapple", portion: "¬Ω cup", category: "fruits", na: 1, k: 100, p: 10, protein: 0, cal: 40 },
            { id: 35, name: "Cranberries", portion: "¬Ω cup", category: "fruits", na: 2, k: 45, p: 8, protein: 0, cal: 20 },
            { id: 36, name: "Raspberries", portion: "¬Ω cup", category: "fruits", na: 1, k: 95, p: 15, protein: 1, cal: 30 },
            { id: 37, name: "Strawberries", portion: "¬Ω cup", category: "fruits", na: 1, k: 115, p: 20, protein: 0, cal: 25 },
            { id: 38, name: "Watermelon", portion: "1 cup", category: "fruits", na: 3, k: 175, p: 15, protein: 1, cal: 50 },
            { id: 39, name: "Pear", portion: "1 medium", category: "fruits", na: 2, k: 200, p: 15, protein: 0, cal: 100 },
            { id: 40, name: "Peach", portion: "1 medium", category: "fruits", na: 0, k: 190, p: 20, protein: 1, cal: 60 },
            { id: 41, name: "White Rice", portion: "¬Ω cup cooked", category: "grains", na: 1, k: 30, p: 20, protein: 2, cal: 70 },
            { id: 42, name: "Brown Rice", portion: "¬Ω cup cooked", category: "grains", na: 10, k: 55, p: 80, protein: 2, cal: 55 },
            { id: 43, name: "Pasta", portion: "¬Ω cup cooked", category: "grains", na: 1, k: 25, p: 20, protein: 4, cal: 110 },
            { id: 44, name: "White Bread", portion: "1 slice", category: "grains", na: 130, k: 25, p: 25, protein: 2, cal: 70 },
            { id: 45, name: "Oatmeal", portion: "¬Ω cup cooked", category: "grains", na: 5, k: 60, p: 70, protein: 3, cal: 75 },
            { id: 46, name: "Couscous", portion: "¬Ω cup cooked", category: "grains", na: 5, k: 40, p: 20, protein: 3, cal: 90 },
            { id: 47, name: "Quinoa", portion: "¬Ω cup cooked", category: "grains", na: 5, k: 90, p: 80, protein: 4, cal: 110 },
            { id: 48, name: "Pancakes", portion: "2 small", category: "grains", na: 350, k: 90, p: 80, protein: 4, cal: 150 },
            { id: 49, name: "Bagel (plain)", portion: "1 medium", category: "grains", na: 450, k: 55, p: 50, protein: 5, cal: 245 },
            { id: 50, name: "Corn Flakes", portion: "1 cup", category: "grains", na: 200, k: 25, p: 10, protein: 2, cal: 100 },
            { id: 51, name: "Olive Oil", portion: "1 tbsp", category: "fats", na: 0, k: 0, p: 0, protein: 0, cal: 120 },
            { id: 52, name: "Butter", portion: "1 tbsp", category: "fats", na: 90, k: 3, p: 3, protein: 0, cal: 100 },
            { id: 53, name: "Cream Cheese", portion: "2 tbsp", category: "fats", na: 140, k: 30, p: 25, protein: 2, cal: 100 },
            { id: 54, name: "Almonds", portion: "10 nuts", category: "fats", na: 0, k: 70, p: 45, protein: 2, cal: 70 },
            { id: 55, name: "Peanut Butter", portion: "1 tbsp", category: "fats", na: 70, k: 60, p: 55, protein: 2, cal: 95 },
            { id: 56, name: "Avocado", portion: "¬º fruit", category: "fats", na: 5, k: 230, p: 30, protein: 1, cal: 80 },
            { id: 57, name: "Margarine", portion: "1 tbsp", category: "fats", na: 90, k: 5, p: 5, protein: 0, cal: 100 },
            { id: 58, name: "Honey", portion: "1 tbsp", category: "fats", na: 1, k: 6, p: 1, protein: 0, cal: 60 },
            { id: 59, name: "Maple Syrup", portion: "1 tbsp", category: "fats", na: 2, k: 10, p: 2, protein: 0, cal: 50 },
            { id: 60, name: "Jam", portion: "1 tbsp", category: "fats", na: 10, k: 15, p: 2, protein: 0, cal: 55 }
        ];

        let currentPlan = {
            breakfast: [],
            lunch: [],
            dinner: [],
            snacks: []
        };

        let savedPlans = {};
        let patientWeight = 70;
        let selectedFood = null;
        let currentCategory = 'all';
        let searchQuery = '';

        function init() {
            loadFromStorage();
            renderFoodGrid();
            renderMealPlan();
            updateTotals();
            updateProteinTarget();
            renderSavedPlans();
            setupEventListeners();
            applyTheme();
        }

        function loadFromStorage() {
            const saved = localStorage.getItem('ckdMealPlanner');
            if (saved) {
                const data = JSON.parse(saved);
                currentPlan = data.currentPlan || { breakfast: [], lunch: [], dinner: [], snacks: [] };
                savedPlans = data.savedPlans || {};
                patientWeight = data.patientWeight || 70;
                document.getElementById('weightInput').value = patientWeight;
            }

            const theme = localStorage.getItem('ckdTheme');
            if (theme) {
                document.documentElement.setAttribute('data-theme', theme);
            }
        }

        function saveToStorage() {
            const data = {
                currentPlan,
                savedPlans,
                patientWeight
            };
            localStorage.setItem('ckdMealPlanner', JSON.stringify(data));
        }

        function applyTheme() {
            const theme = localStorage.getItem('ckdTheme') || 'light';
            document.documentElement.setAttribute('data-theme', theme);
            document.getElementById('themeIcon').textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        function setupEventListeners() {
            document.getElementById('themeToggle').addEventListener('click', () => {
                const current = document.documentElement.getAttribute('data-theme');
                const newTheme = current === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('ckdTheme', newTheme);
                document.getElementById('themeIcon').textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            });

            document.getElementById('printBtn').addEventListener('click', () => {
                document.getElementById('printDate').textContent = new Date().toLocaleDateString('en-US', { 
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
                });
                window.print();
            });

            document.getElementById('weightInput').addEventListener('input', (e) => {
                patientWeight = parseFloat(e.target.value) || 70;
                updateProteinTarget();
                saveToStorage();
            });

            document.getElementById('searchInput').addEventListener('input', (e) => {
                searchQuery = e.target.value.toLowerCase();
                renderFoodGrid();
            });

            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentCategory = btn.dataset.category;
                    renderFoodGrid();
                });
            });

            document.querySelectorAll('.meal-option').forEach(option => {
                option.addEventListener('click', () => {
                    if (selectedFood) {
                        addFoodToMeal(selectedFood, option.dataset.meal);
                        closeModal();
                    }
                });
            });

            document.getElementById('closeModal').addEventListener('click', closeModal);
            document.getElementById('mealModal').addEventListener('click', (e) => {
                if (e.target.id === 'mealModal') closeModal();
            });

            document.getElementById('savePlanBtn').addEventListener('click', savePlan);
            document.getElementById('loadPlanBtn').addEventListener('click', loadPlan);
            document.getElementById('deletePlanBtn').addEventListener('click', deletePlan);
            document.getElementById('exportJsonBtn').addEventListener('click', exportJson);
            document.getElementById('importJsonInput').addEventListener('change', importJson);
        }

        function renderFoodGrid() {
            const grid = document.getElementById('foodGrid');
            let foods = foodDatabase;

            if (currentCategory !== 'all') {
                foods = foods.filter(f => f.category === currentCategory);
            }

            if (searchQuery) {
                foods = foods.filter(f => f.name.toLowerCase().includes(searchQuery));
            }

            if (foods.length === 0) {
                grid.innerHTML = '<div class="no-results">No foods found</div>';
                return;
            }

            grid.innerHTML = foods.map(food => `
                <div class="food-card" data-food-id="${food.id}">
                    <div class="food-card-name">${food.name}</div>
                    <div class="food-card-portion">${food.portion}</div>
                    <div class="nutrient-badges">
                        <span class="nutrient-badge badge-na">${food.na}mg Na</span>
                        <span class="nutrient-badge badge-k">${food.k}mg K</span>
                        <span class="nutrient-badge badge-p">${food.p}mg P</span>
                        <span class="nutrient-badge badge-protein">${food.protein}g</span>
                        <span class="nutrient-badge badge-cal">${food.cal}</span>
                    </div>
                </div>
            `).join('');

            grid.querySelectorAll('.food-card').forEach(card => {
                card.addEventListener('click', () => {
                    const foodId = parseInt(card.dataset.foodId);
                    selectedFood = foodDatabase.find(f => f.id === foodId);
                    openModal(selectedFood);
                });
            });
        }

        function openModal(food) {
            document.getElementById('modalFoodName').textContent = `${food.name} (${food.portion})`;
            updateMealNutrientDisplays();
            document.getElementById('mealModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('mealModal').classList.remove('active');
            selectedFood = null;
        }

        function updateMealNutrientDisplays() {
            ['breakfast', 'lunch', 'dinner', 'snacks'].forEach(meal => {
                const total = currentPlan[meal].reduce((sum, item) => sum + item.cal, 0);
                document.getElementById(`${meal}Total`).textContent = `${total} cal`;
            });
        }

        function addFoodToMeal(food, meal) {
            currentPlan[meal].push({ ...food, uniqueId: Date.now() });
            saveToStorage();
            renderMealPlan();
            updateTotals();
            showToast(`Added ${food.name} to ${meal}`, 'success');
        }

        function removeFoodFromMeal(meal, uniqueId) {
            currentPlan[meal] = currentPlan[meal].filter(item => item.uniqueId !== uniqueId);
            saveToStorage();
            renderMealPlan();
            updateTotals();
        }

        function renderMealPlan() {
            ['breakfast', 'lunch', 'dinner', 'snacks'].forEach(meal => {
                const container = document.querySelector(`[data-meal-content="${meal}"]`);
                const listEl = container.querySelector('.meal-food-list');
                const emptyEl = container.querySelector('.empty');
                const foods = currentPlan[meal];

                if (foods.length === 0) {
                    listEl.innerHTML = '';
                    emptyEl.style.display = 'flex';
                } else {
                    emptyEl.style.display = 'none';
                    listEl.innerHTML = foods.map(item => `
                        <div class="meal-food-item">
                            <div class="meal-food-info">
                                <div class="meal-food-name">${item.name}</div>
                                <div class="meal-food-nutrients">${item.na}mg Na ‚Ä¢ ${item.k}mg K ‚Ä¢ ${item.p}mg P ‚Ä¢ ${item.protein}g protein ‚Ä¢ ${item.cal} cal</div>
                            </div>
                            <button class="remove-btn" data-meal="${meal}" data-unique-id="${item.uniqueId}">‚úï</button>
                        </div>
                    `).join('');
                }

                const totalCal = foods.reduce((sum, item) => sum + item.cal, 0);
                document.querySelector(`[data-meal-cal="${meal}"]`).textContent = `${totalCal} cal`;
            });

            // Re-attach event listeners to all remove buttons
            document.querySelectorAll('.remove-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    removeFoodFromMeal(btn.dataset.meal, parseInt(btn.dataset.uniqueId));
                });
            });
        }

        function updateTotals() {
            const totals = { na: 0, k: 0, p: 0, protein: 0, cal: 0 };
            
            Object.values(currentPlan).forEach(meal => {
                meal.forEach(item => {
                    totals.na += item.na;
                    totals.k += item.k;
                    totals.p += item.p;
                    totals.protein += item.protein;
                    totals.cal += item.cal;
                });
            });

            document.getElementById('totalNa').innerHTML = `${totals.na}<small>mg</small>`;
            document.getElementById('totalK').innerHTML = `${totals.k}<small>mg</small>`;
            document.getElementById('totalP').innerHTML = `${totals.p}<small>mg</small>`;
            document.getElementById('totalProtein').innerHTML = `${totals.protein}<small>g</small>`;
            document.getElementById('totalCal').textContent = totals.cal;

            updateProgressBar('Na', totals.na, 2000, true);
            updateProgressBar('K', totals.k, 3000, false, 2000);
            updateProgressBar('P', totals.p, 1000, false, 800);
            updateProgressBar('Protein', totals.protein, patientWeight * 1.0, false, patientWeight * 0.8);
            updateProgressBar('Cal', totals.cal, 2500, false);
        }

        function updateProgressBar(nutrient, value, max, isUpperOnly = false, min = 0) {
            const progress = document.getElementById(`progress${nutrient}`);
            const valueEl = document.getElementById(`total${nutrient}`);
            let percent, color;

            if (nutrient === 'Na') {
                percent = (value / max) * 100;
                if (percent < 75) color = 'green';
                else if (percent < 100) color = 'yellow';
                else color = 'red';
            } else if (nutrient === 'K' || nutrient === 'P') {
                if (value < min) {
                    percent = (value / min) * 50;
                    color = 'yellow';
                } else if (value <= max) {
                    percent = 50 + ((value - min) / (max - min)) * 50;
                    color = 'green';
                } else {
                    percent = Math.min(100, 50 + ((value - max) / max) * 50);
                    color = 'red';
                }
            } else if (nutrient === 'Protein') {
                const targetMin = min;
                const targetMax = max;
                if (value < targetMin * 0.8) {
                    percent = (value / (targetMin * 0.8)) * 40;
                    color = 'yellow';
                } else if (value <= targetMax) {
                    percent = 40 + ((value - targetMin * 0.8) / (targetMax - targetMin * 0.8)) * 60;
                    color = 'green';
                } else {
                    percent = Math.min(100, 40 + ((value - targetMax) / targetMax) * 60);
                    color = 'red';
                }
            } else {
                percent = Math.min(100, (value / max) * 100);
                color = 'green';
            }

            progress.style.width = `${Math.min(100, percent)}%`;
            progress.className = `progress-fill progress-${color}`;
            valueEl.className = `total-value status-${color}`;
        }

        function updateProteinTarget() {
            const min = Math.round(patientWeight * 0.8);
            const max = Math.round(patientWeight * 1.0);
            document.getElementById('proteinTarget').textContent = `${min}-${max}g`;
            document.getElementById('targetProteinRange').textContent = `${min}-${max}g`;
        }

        function savePlan() {
            const name = document.getElementById('planNameInput').value.trim();
            if (!name) {
                showToast('Please enter a plan name', 'error');
                return;
            }
            savedPlans[name] = JSON.parse(JSON.stringify(currentPlan));
            saveToStorage();
            renderSavedPlans();
            document.getElementById('planNameInput').value = '';
            showToast(`Plan "${name}" saved!`, 'success');
        }

        function loadPlan() {
            const name = document.getElementById('planSelect').value;
            if (!name || !savedPlans[name]) {
                showToast('Please select a plan to load', 'error');
                return;
            }
            currentPlan = JSON.parse(JSON.stringify(savedPlans[name]));
            saveToStorage();
            renderMealPlan();
            updateTotals();
            showToast(`Loaded plan "${name}"`, 'success');
        }

        function deletePlan() {
            const name = document.getElementById('planSelect').value;
            if (!name || !savedPlans[name]) {
                showToast('Please select a plan to delete', 'error');
                return;
            }
            delete savedPlans[name];
            saveToStorage();
            renderSavedPlans();
            showToast(`Deleted plan "${name}"`, 'success');
        }

        function exportJson() {
            const data = {
                currentPlan,
                savedPlans,
                patientWeight,
                exportedAt: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ckd-meal-planner-${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Plan exported successfully!', 'success');
        }

        function importJson(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    if (typeof data !== 'object' || data === null) throw new Error('Invalid format');
                    if (data.currentPlan) {
                        const meals = ['breakfast', 'lunch', 'dinner', 'snacks'];
                        const validPlan = meals.every(m => Array.isArray(data.currentPlan[m]));
                        if (!validPlan) throw new Error('Invalid plan structure');
                        currentPlan = data.currentPlan;
                    }
                    if (data.savedPlans && typeof data.savedPlans === 'object') {
                        savedPlans = data.savedPlans;
                    }
                    if (typeof data.patientWeight === 'number' && data.patientWeight > 0) {
                        patientWeight = data.patientWeight;
                        document.getElementById('weightInput').value = patientWeight;
                        updateProteinTarget();
                    }
                    saveToStorage();
                    renderSavedPlans();
                    renderMealPlan();
                    updateTotals();
                    showToast('Plan imported successfully!', 'success');
                } catch (err) {
                    showToast('Invalid JSON file: ' + err.message, 'error');
                }
                e.target.value = '';
            };
            reader.readAsText(file);
        }

        function renderSavedPlans() {
            const select = document.getElementById('planSelect');
            const names = Object.keys(savedPlans);
            select.innerHTML = '<option value="">Select a plan...</option>' + 
                names.map(name => `<option value="${name}">${name}</option>`).join('');
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
